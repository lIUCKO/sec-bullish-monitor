name: SEC Bullish Monitor PRO + RSS

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"   # svakih 30 min

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      SEC_API_KEY: ${{ secrets.SEC_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch & save all bullish categories (JSON/CSV)
        run: |
          python - <<'PY'
          import os, csv, json, datetime as dt, requests, pathlib, sys

          key = os.getenv("SEC_API_KEY")
          if not key:
            print("❌ SEC_API_KEY missing"); sys.exit(1)

          def save_files(name, rows, cols):
            p = pathlib.Path(".")
            jp, cp = p/f"{name}.json", p/f"{name}.csv"
            with open(jp, "w", encoding="utf-8") as f:
              json.dump({"count": len(rows), "filings": rows}, f, ensure_ascii=False, indent=2)
            with open(cp, "w", newline="", encoding="utf-8") as f:
              w = csv.writer(f); w.writerow(cols)
              for r in rows:
                w.writerow([r.get(c,"") for c in cols])
            print(f"Saved {len(rows)} → {jp}, {cp}")

          def query_sec(query, size=100):
            url = "https://api.sec-api.io"
            payload = {"query": query, "from": "0", "size": str(size), "sort":[{"filedAt":{"order":"desc"}}]}
            r = requests.post(url, headers={"Authorization": key}, json=payload, timeout=40)
            print("HTTP:", r.status_code, "| len(query):", len(query))
            r.raise_for_status()
            return r.json().get("filings", [])

          # vremenski prozor: zadnjih 24h
          today = dt.date.today()
          d1 = today - dt.timedelta(days=1)
          window = f"[{d1.isoformat()} TO {today.isoformat()}]"

          # zajedničke kolone za CSV
          COLS = ["filedAt","companyName","ticker","formType","accessionNo","linkToFiling","items","documentFormatFiles"]

          # 1) 8-K bullish (7.01/2.02 + fraze)
          q_8k_bullish = (
            f'formType:"8-K" AND filedAt:{window} AND '
            f'(items:"7.01" OR items:"2.02") AND '
            f'("guidance raised" OR "buyback" OR "increased outlook" OR '
            f'"dividend increase" OR "partnership" OR "contract award" OR "FDA approval") '
            f'NOT ("ATM" OR "offering" OR "termination" OR "delist")'
          )
          rows = query_sec(q_8k_bullish, 80)
          save_files("8K_bullish", rows, COLS)

          # 2) 8-K Material Agreement (Item 1.01) + partnerstva/ugovori
          q_8k_mat = (
            f'formType:"8-K" AND filedAt:{window} AND items:"1.01" AND '
            f'("material agreement" OR "partnership" OR "strategic partnership" OR '
            f'"supply agreement" OR "distribution agreement" OR "licensing agreement" OR '
            f'"collaboration agreement" OR "contract" OR "master services agreement") '
            f'NOT ("termination" OR "amendment only" OR "ATM" OR "equity offering")'
          )
          rows = query_sec(q_8k_mat, 120)
          save_files("8K_material_agreements", rows, COLS)

          # 3) 10-Q bullish fraze
          q_10q = (
            f'formType:"10-Q" AND filedAt:{window} AND '
            f'("guidance raised" OR "improved outlook" OR "profitability" OR '
            f'"returning to growth" OR "margin expansion") '
            f'NOT ("going concern" OR "liquidity risk" OR "covenant breach")'
          )
          rows = query_sec(q_10q, 60)
          save_files("10Q_bullish", rows, COLS)

          # 4) Form 4 insider kupnje (A = acquired ili P = purchase)
          q_f4 = (
            f'formType:"4" AND filedAt:{window} AND '
            f'(transactionAcquiredDisposedCode:"A" OR transactionCode:"P")'
          )
          rows = query_sec(q_f4, 200)
          save_files("Form4_buys", rows, COLS)

          # 5) 13D / 13G (novi/izmijenjeni veliki udjeli)
          q_13 = (
            f'formType:("SC 13D" OR "SC 13G") AND filedAt:{window} '
            f'NOT ("amendment no. 10" OR "inactive")'
          )
          rows = query_sec(q_13, 100)
          save_files("13D_13G", rows, COLS)
          PY

      - name: Build merged RSS feed (sec-bullish.xml)
        run: |
          python - <<'PY'
          import json, datetime as dt, pathlib, html

          now = dt.datetime.utcnow()
          def load(name):
            p = pathlib.Path(f"{name}.json")
            if not p.exists(): return []
            with p.open("r", encoding="utf-8") as f:
              return json.load(f).get("filings", [])

          # Spoji sve kategorije
          cats = [
            ("8K_bullish", "8-K Bullish"),
            ("8K_material_agreements", "8-K Material Agreement"),
            ("10Q_bullish", "10-Q Bullish"),
            ("Form4_buys", "Form 4 Insider Buy"),
            ("13D_13G", "13D/13G Ownership"),
          ]
          items = []
          for fname, label in cats:
            for x in load(fname):
              items.append((fname, label, x))

          # Sort: filedAt desc (string sort je ok jer format je ISO-like)
          items.sort(key=lambda t: t[2].get("filedAt",""), reverse=True)

          rss_items = []
          for fname, label, f in items[:200]:
            title = f"{f.get('ticker','?')} | {label} | {f.get('companyName','?')}"
            link  = f.get("linkToFiling") or "https://www.sec.gov"
            pub   = f.get("filedAt","")
            desc  = f"Form: {f.get('formType','?')} | Items: {f.get('items','')} | Accession: {f.get('accessionNo','')}"
            guid  = f.get('accessionNo','') or (f.get('ticker','?')+pub)
            rss_items.append(f"""
              <item>
                <title>{html.escape(title)}</title>
                <link>{html.escape(link)}</link>
                <guid isPermaLink="false">{html.escape(guid)}</guid>
                <pubDate>{html.escape(pub)}</pubDate>
                <description>{html.escape(desc)}</description>
              </item>
            """)

          rss = f"""<?xml version="1.0" encoding="UTF-8"?>
          <rss version="2.0">
            <channel>
              <title>SEC Bullish Monitor (PRO)</title>
              <link>https://github.com/${{ github.repository }}</link>
              <description>8-K Bullish, Item 1.01 (Material Agreements), 10-Q Bullish, Form 4 buys, 13D/13G</description>
              <lastBuildDate>{now.strftime("%a, %d %b %Y %H:%M:%S +0000")}</lastBuildDate>
              {''.join(rss_items)}
            </channel>
          </rss>"""
          out = pathlib.Path("sec-bullish.xml")
          out.write_text(rss.strip(), encoding="utf-8")
          print("RSS generated:", out, "size:", out.stat().st_size)
          PY

      - name: Commit & push outputs
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add 8K_bullish.json 8K_bullish.csv \
                 8K_material_agreements.json 8K_material_agreements.csv \
                 10Q_bullish.json 10Q_bullish.csv \
                 Form4_buys.json Form4_buys.csv \
                 13D_13G.json 13D_13G.csv \
                 sec-bullish.xml
          git commit -m "update: SEC Bullish PRO + RSS" || echo "No changes"
          git push
