name: SEC Bullish (minimal)

on:
  workflow_dispatch:          # ruƒçno pokretanje
  schedule:
    - cron: "*/15 * * * *"    # svakih 15 minuta

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      SEC_API_KEY: ${{ secrets.SEC_API_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Test SEC-API connection
        run: |
          python - <<'PY'
          import os, requests, json
          key = os.getenv("SEC_API_KEY")
          if not key:
              raise SystemExit("‚ùå SEC_API_KEY nije pronaƒëen u secrets.")
          print("üîë Kljuƒç uƒçitan (duljina:", len(key), ")")

          url = "https://api.sec-api.io"
          payload = {
              "query": 'formType:"8-K"',
              "from": "0",
              "size": "2",
              "sort": [{"filedAt": {"order": "desc"}}]
          }

          r = requests.post(url, headers={"Authorization": key}, json=payload, timeout=30)
          print("HTTP:", r.status_code)
          print(r.text[:600])
          r.raise_for_status()
          print("‚úÖ SEC API radi ispravno.")
          PY

      - name: Commit marker
        run: |
          echo "Last run: $(date)" > last_run.txt
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add last_run.txt
          git commit -m "update: last run marker" || echo "No changes"
          git push
